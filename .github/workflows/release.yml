name: Release & Publish

on:
  push:
    branches: [ main, master ]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Tag Release
        id: tag_version
        run: |
          VERSION=$(jq -r '."version-string"' vcpkg.json)
          TAG="v$VERSION"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "Tag $TAG already exists"
            echo "new_tag=false" >> $GITHUB_OUTPUT
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "new_tag=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Calculate SHA512
        if: steps.tag_version.outputs.new_tag == 'true'
        id: calculate_sha
        run: |
          VERSION=${{ steps.tag_version.outputs.version }}
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/v${VERSION}.tar.gz"
          echo "Downloading from $URL"
          sleep 5
          curl -L -o release.tar.gz "$URL"
          SHA512=$(sha512sum release.tar.gz | awk '{print $1}')
          echo "SHA512=$SHA512" >> $GITHUB_OUTPUT

      - name: Setup vcpkg
        if: steps.tag_version.outputs.new_tag == 'true'
        run: |
          ./lib/vcpkg/bootstrap-vcpkg.sh

      - name: Publish to Registry
        if: steps.tag_version.outputs.new_tag == 'true'
        env:
          REGISTRY_PAT: ${{ secrets.REGISTRY_PAT }}
          VERSION: ${{ steps.tag_version.outputs.version }}
          SHA512: ${{ steps.calculate_sha.outputs.SHA512 }}
        run: |
          git clone https://x-access-token:${REGISTRY_PAT}@github.com/JakubSzwedowicz/vcpkg-registry.git registry_repo
          cd registry_repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          mkdir -p ports/utils
          cp ../vcpkg.json ports/utils/vcpkg.json

          sed "s/__SHA512__/${SHA512}/g" \
            ../.github/templates/portfile.cmake.in > ports/utils/portfile.cmake

          # Step 1: Commit port changes first (x-add-version reads committed state)
          git add ports/
          git commit -m "Update utils port to v${VERSION}" || echo "No port changes"

          # Step 2: Update version database using vcpkg
          ../lib/vcpkg/vcpkg x-add-version --all --overwrite-version

          # Step 3: Commit version database and push
          git add versions/
          git commit -m "Update versions for utils v${VERSION}" || echo "No version changes"

          git push origin main
